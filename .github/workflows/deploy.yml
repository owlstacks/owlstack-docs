name: Deploy Docs to Server

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy docs to server
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          command_timeout: 15m
          script: |
            set -e

            DEPLOY_DIR="${{ secrets.DEPLOY_PATH }}"
            DOCS_DIR="${{ secrets.DOCS_PATH }}"

            echo "=========================================="
            echo "OwlStack Docs Deploy â€” $(date)"
            echo "=========================================="

            # Pull latest docs code
            echo ">>> Pulling latest docs code..."
            cd "$DOCS_DIR"
            git fetch origin main
            git reset --hard origin/main

            # Build and restart docs service only
            cd "$DEPLOY_DIR"
            echo ">>> Building docs..."
            docker compose -f docker-compose.yml -f docker-compose.server.yml build docs
            echo ">>> Restarting docs service..."
            docker compose -f docker-compose.yml -f docker-compose.server.yml up -d docs

            # Clean up
            docker image prune -f

            echo "=========================================="
            echo "Docs deploy complete!"
            echo "=========================================="
